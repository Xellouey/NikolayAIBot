# Исправление ошибки SQLite многопоточности

## Проблема
Возникала ошибка: "SQLite objects created in a thread can only be used in that same thread"

Это происходило потому, что SQLite по умолчанию не позволяет использовать соединения между потоками, а в боте используется asyncio с run_in_executor, который выполняет код в разных потоках.

## Решение

### 1. Обновлен database/core.py:

- Добавлен параметр `check_same_thread=False` при создании соединения
- Включен режим WAL (Write-Ahead Logging) для лучшей конкурентности
- Добавлена функция `init_db()` для правильной инициализации соединения
- Улучшен AsyncManager с поддержкой thread-local соединений через `threading.local()`
- Добавлен метод `_ensure_connection()` для проверки и создания соединения в каждом потоке

### 2. Обновлен nikolayai.py:

- Добавлен вызов `init_db()` при запуске бота для правильной инициализации базы данных

## Преимущества исправления

1. **Thread-safety**: Каждый поток теперь работает со своим соединением
2. **WAL режим**: Улучшенная производительность при конкурентных запросах
3. **Кеширование**: Добавлен кеш размером 64MB для ускорения запросов
4. **Надежность**: Автоматическое переподключение при потере соединения

## Важно

После внесения изменений **требуется перезапуск бота** для применения новых настроек базы данных.

## Команда для перезапуска

```bash
# Остановите текущий процесс (Ctrl+C) и запустите заново:
python nikolayai.py
```
